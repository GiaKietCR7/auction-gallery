<%- include('partials/head', { title: item.title }) %>

<div class="grid lg:grid-cols-2 gap-10">
  <div>
    <div class="relative">
      <img id="mainImg" src="<%= getImageUrl(gallery[0]) %>" alt="<%= item.title %>" class="w-full rounded-2xl shadow-card object-cover" />
      <% if (gallery.length > 1) { %>
        <button id="prevBtn" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 border rounded-full px-3 py-1">‹</button>
        <button id="nextBtn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 border rounded-full px-3 py-1">›</button>
      <% } %>
    </div>

    <% if (gallery.length > 1) { %>
      <div class="mt-3 grid grid-cols-6 gap-2">
        <% gallery.forEach(function(g, idx){ %>
          <img data-idx="<%= idx %>" src="<%= getImageUrl(g) %>" class="thumb border rounded cursor-pointer h-16 w-full object-cover <%= idx===0 ? 'ring-2 ring-black' : '' %>" />
        <% }) %>
      </div>
    <% } %>
  </div>

  <div class="space-y-6">
    <h1 class="font-serif text-4xl leading-tight"><%= item.title %></h1>
    <p class="text-ink/70"><%= item.description %></p>

    <div class="border rounded-2xl p-5">
      <div class="grid grid-cols-2 gap-4 text-[14px]">
        <div>Starting price</div><div class="text-right font-medium">$<%= Number(item.start_price ?? 0).toFixed(2) %></div>
        <div>Minimum increment</div><div class="text-right font-medium">$<%= Number(item.min_increment ?? 0).toFixed(2) %></div>
        <div>Highest bid</div><div class="text-right font-medium">
          $<%= Number((item.topbid ?? item.start_price) ?? 0).toFixed(2) %>
        </div>
        <div>Total bids</div><div class="text-right"><%= item.bidcount %></div>
        <div>Ends</div>
        <div class="text-right">
          <span id="endTime" data-end="<%= item.end_time ? new Date(item.end_time).toISOString() : '' %>">
            <%= item.end_time ? new Date(item.end_time).toLocaleString() : '—' %>
          </span>
          <div id="countdown" class="text-[12px] text-ink/60"></div>
        </div>
      </div>
    </div>

    <!-- Bỏ phần owner vì server chưa truyền biến owner -->
    <% if (!item.ended && item.status==='active') { %>
      <form action="/item/<%= item.id %>/bid" method="POST" class="border rounded-2xl p-5 space-y-3">
        <div class="font-medium">Place a bid</div>
        <input type="text" name="bidder" placeholder="Your name" required class="border rounded-full px-4 py-2 w-full text-[14px]" />
        <input type="number" step="0.01" min="0" name="amount" placeholder="Amount ($)" required class="border rounded-full px-4 py-2 w-full text-[14px]" />
        <button class="bg-ink text-white px-5 py-2 rounded-full text-[14px] hover:opacity-90">Place Bid</button>
        <p class="text-[12px] text-ink/50">Minimum = current price + increment step.</p>
      </form>
    <% } else { %>
      <div class="border rounded-2xl p-5 text-ink/60">This auction has ended.</div>
    <% } %>

    <div class="border rounded-2xl p-5">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Bid History</div>
      </div>

      <ul class="divide-y">
        <% bids.forEach(b => { %>
          <li class="py-2 flex justify-between text-[14px]">
            <span><%= b.bidder %></span>
            <span>$<%= Number(b.amount).toFixed(2) %></span>
          </li>
        <% }) %>
        <% if (!bids.length) { %>
          <li class="py-2 text-ink/50 text-[14px]">No bids yet.</li>
        <% } %>
      </ul>
    </div>
  </div>
</div>

<script>
(function () {
  // countdown
  const el = document.getElementById('endTime');
  const cd = document.getElementById('countdown');
  if (el && cd) {
    const iso = el.dataset.end;
    if (iso) {
      function tick() {
        const end = new Date(iso).getTime();
        const now = Date.now();
        const diff = end - now;
        if (diff <= 0) { cd.textContent = "Time's up."; return; }
        const h = Math.floor(diff / 3.6e6);
        const m = Math.floor((diff % 3.6e6) / 6e4);
        const s = Math.floor((diff % 6e4) / 1000);
        cd.textContent = `Time left: ${h}h ${m}m ${s}s`;
        requestAnimationFrame(tick);
      }
      tick();
    }
  }

  // gallery
  const gallery = <%- JSON.stringify(gallery.map(g => getImageUrl(g))) %>;
  const main = document.getElementById('mainImg');
  const thumbs = document.querySelectorAll('.thumb');
  let cur = 0;

  function show(i) {
    cur = (i + gallery.length) % gallery.length;
    main.src = gallery[cur];
    thumbs.forEach((t, idx) => {
      if (idx === cur) { t.classList.add('ring-2', 'ring-black'); }
      else { t.classList.remove('ring-2', 'ring-black'); }
    });
  }

  thumbs.forEach(t => t.addEventListener('click', () => show(parseInt(t.dataset.idx, 10))));
  const prev = document.getElementById('prevBtn');
  const next = document.getElementById('nextBtn');
  if (prev) prev.addEventListener('click', () => show(cur - 1));
  if (next) next.addEventListener('click', () => show(cur + 1));
})();
</script>

<%- include('partials/foot') %>
